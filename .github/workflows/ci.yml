name: CI

# PR과 Push 시 자동 실행
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # 작업 1: 린트 체크
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4
      
      - name: Node.js 설치
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 의존성 설치
        run: npm install
      
      - name: ESLint 실행
        run: npm run lint
        continue-on-error: false # 린트 실패 시 중단

  # 작업 2: TypeScript 타입 체크
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4
      
      - name: Node.js 설치
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 의존성 설치
        run: npm install
      
      - name: TypeScript 컴파일 체크
        run: npx tsc --noEmit
        continue-on-error: false

  # 작업 3: 테스트 실행
  test:
    name: Jest Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4
      
      - name: Node.js 설치
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 의존성 설치
        run: npm install
      
      - name: 테스트 실행
        run: npm test -- --coverage --watchAll=false
        continue-on-error: false
      
      - name: 커버리지 리포트 업로드 (선택사항)
        uses: codecov/codecov-action@v4
        if: success() # 테스트 성공 시에만
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true # 실패해도 진행

  # 작업 4: 빌드 체크 (Vite)
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test] # 선행 작업 완료 후 실행
    
    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4
      
      - name: Node.js 설치
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 의존성 설치
        run: npm install
      
      - name: Vite 빌드
        run: npm run build
        continue-on-error: false
      
      - name: 빌드 결과 확인
        run: |
          echo "빌드 성공!"
          ls -lah dist/
          if [ ! -d "dist/assets" ]; then
            echo "오류: dist/assets가 생성되지 않았습니다"
            exit 1
          fi
