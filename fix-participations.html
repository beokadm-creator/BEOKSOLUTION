<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participations Recovery Tool</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #2d80c6;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, button {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: #2d80c6;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #1a5a8c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Participations ë³µêµ¬ ë„êµ¬</h1>
        <p>ê²°ì œ ì™„ë£Œëœ ì‚¬ìš©ìê°€ ë§ˆì´í˜ì´ì§€ì—ì„œ ë“±ë¡ ë‚´ì—­ì„ ë³¼ ìˆ˜ ì—†ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        
        <div class="form-group">
            <label for="userId">User UID:</label>
            <input type="text" id="userId" placeholder="ì˜ˆ: K2ufvNWpJsNc0KbyrGdZLf4PdU32" value="K2ufvNWpJsNc0KbyrGdZLf4PdU32">
        </div>
        
        <div class="form-group">
            <label for="conferenceId">Conference ID (ì„ íƒì‚¬í•­):</label>
            <input type="text" id="conferenceId" placeholder="ì˜ˆ: kadd_2026spring">
        </div>
        
        <button id="recoverBtn" onclick="recoverParticipations()">ğŸš€ ì°¸ì—¬ ê¸°ë¡ ë³µêµ¬ ì‹œì‘</button>
        
        <div id="output">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC7xR1tF3nY2qW5zX6vK7aB8cD9eF0gH1",
            authDomain: "eregi-8fc1e.firebaseapp.com",
            projectId: "eregi-8fc1e",
            storageBucket: "eregi-8fc1e.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function recoverParticipations() {
            const userId = document.getElementById('userId').value.trim();
            const conferenceId = document.getElementById('conferenceId').value.trim();
            const output = document.getElementById('output');
            const btn = document.getElementById('recoverBtn');
            
            if (!userId) {
                output.innerHTML = '<span class="error">âŒ User UIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.</span>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'â³ ë³µêµ¬ ì¤‘...';
            output.innerHTML = '<span class="info">ğŸ” ê²€ìƒ‰ ì¤‘...</span>\n';
            
            try {
                // Step 1: Find all paid registrations for this user
                let registrationsQuery = db.collectionGroup('registrations')
                    .where('userId', '==', userId)
                    .where('status', '==', 'PAID');
                
                // If conferenceId is specified, also filter by conferenceId (path-based)
                if (conferenceId) {
                    // Need to query from specific conference path
                    const specificQuery = db.collection(`conferences/${conferenceId}/registrations`)
                        .where('userId', '==', userId)
                        .where('status', '==', 'PAID');
                    
                    const specificSnap = await specificQuery.get();
                    
                    if (specificSnap.empty) {
                        output.innerHTML += '<span class="info">ğŸ“‹ ì´ ì»¨í¼ëŸ°ìŠ¤ì—ì„œëŠ” ê²°ì œ ì™„ë£Œëœ ë“±ë¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì „ì²´ ê²€ìƒ‰ì„ ì‹œë„í•©ë‹ˆë‹¤...</span>\n';
                    } else {
                        output.innerHTML += `<span class="success">âœ… ${specificSnap.size}ê°œì˜ ê²°ì œ ì™„ë£Œëœ ë“±ë¡ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</span>\n`;
                        await processRegistrations(specificSnap, userId, output);
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ ì°¸ì—¬ ê¸°ë¡ ë³µêµ¬ ì‹œì‘';
                        return;
                    }
                }
                
                // Step 2: If no specific conference or not found, search all
                const registrationSnap = await registrationsQuery.get();
                
                if (registrationSnap.empty) {
                    output.innerHTML += '<span class="error">âŒ ê²°ì œ ì™„ë£Œëœ ë“±ë¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>\n';
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ ì°¸ì—¬ ê¸°ë¡ ë³µêµ¬ ì‹œì‘';
                    return;
                }
                
                output.innerHTML += `<span class="success">âœ… ì „ì²´ ê²€ìƒ‰ì—ì„œ ${registrationSnap.size}ê°œì˜ ê²°ì œ ì™„ë£Œëœ ë“±ë¡ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</span>\n`;
                
                await processRegistrations(registrationSnap, userId, output);
                
            } catch (error) {
                console.error('Error:', error);
                output.innerHTML += `<span class="error">âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</span>\n`;
                if (error.message.includes('index')) {
                    output.innerHTML += '<span class="info">âš ï¸ ì»¬ë ‰ì…˜ ê·¸ë£¹ ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. Firebase Consoleì—ì„œ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.</span>\n';
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸš€ ì°¸ì—¬ ê¸°ë¡ ë³µêµ¬ ì‹œì‘';
        }

        async function processRegistrations(snap, userId, output) {
            const participationRef = db.collection(`users/${userId}/participations`);
            let recoveredCount = 0;
            let skippedCount = 0;
            const batch = db.batch();
            
            for (const doc of snap.docs) {
                const regData = doc.data();
                const regId = doc.id;
                
                // Check if participation already exists
                const existingParticipation = await participationRef.doc(regId).get();
                
                if (existingParticipation.exists) {
                    output.innerHTML += `<span class="info">â„¹ï¸ ì°¸ì—¬ ê¸°ë¡ ${regId}ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤.</span>\n`;
                    skippedCount++;
                    continue;
                }
                
                // Extract conference info
                let confId = regData.conferenceId;
                if (!confId && doc.ref.parent.parent) {
                    confId = doc.ref.parent.parent.id;
                }
                
                // Create participation record
                const participationData = {
                    conferenceId: confId || 'unknown',
                    societyId: regData.societyId || 'kadd',
                    slug: regData.slug || 'kadd_2026spring',
                    userName: regData.userName || regData.userInfo?.name || 'Unknown',
                    userEmail: regData.userEmail || regData.userInfo?.email || '',
                    userPhone: regData.userPhone || regData.userInfo?.phone || '',
                    userOrg: regData.userOrg || regData.userInfo?.org || regData.affiliation || '',
                    licenseNumber: regData.licenseNumber || '',
                    tier: regData.tier || regData.grade || 'UNKNOWN',
                    paymentStatus: 'PAID',
                    amount: regData.amount || 0,
                    paymentKey: regData.paymentKey || '',
                    paymentType: regData.paymentType || 'ì¹´ë“œ',
                    createdAt: regData.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                    paidAt: regData.paidAt || firebase.firestore.FieldValue.serverTimestamp(),
                    earnedPoints: 0
                };
                
                batch.set(participationRef.doc(regId), participationData);
                recoveredCount++;
                
                output.innerHTML += `<span class="success">âœ… ì°¸ì—¬ ê¸°ë¡ ìƒì„±: ${regId} (${participationData.slug})</span>\n`;
            }
            
            // Commit batch (max 500 operations)
            if (recoveredCount > 0) {
                await batch.commit();
                output.innerHTML += `<span class="success">ğŸ‰ ì„±ê³µì ìœ¼ë¡œ ${recoveredCount}ê°œì˜ ì°¸ì—¬ ê¸°ë¡ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤! ${skippedCount}ê°œëŠ” ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.</span>\n`;
            } else {
                output.innerHTML += '<span class="info">â„¹ï¸ ë³µêµ¬í•  ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ ëª¨ë‘ ì¡´ì¬)</span>\n';
            }
        }
    </script>
</body>
</html>
