# 회원 인증 후 할인 금액 적용 문제 분석 리포트

## 문제 개요
회원이 마이페이지에서 학회 인증을 완료했음에도 불구하고, 등록 페이지에서 회원 할인 금액이 적용되지 않는 문제가 발생하고 있습니다.

## 분석 대상 코드
1. **RegistrationPage.tsx**: 가격 계산 로직 (lines 810-827)
2. **useAuth.ts**: 인증 상태 확인 (lines 342-354)
3. **useMemberVerification.ts**: 인증 데이터 저장 로직 (lines 75-89)
4. **useSocietyGrades.ts**: 등급 정보 로딩 (lines 28-75)

## 문제 분석 결과

### 1. 핵심 문제: 가격 키와 등급 ID 불일치

**문제 지점**: `RegistrationPage.tsx:813-816`
```typescript
const priceKey = selectedGradeId;
const tierPrice = activePeriod.prices[priceKey]
               ?? activePeriod.prices[selectedGrade?.code || '']
               ?? activePeriod.prices[selectedGrade?.name || ''];
```

**원인 분석**:
- `selectedGradeId`는 `activePeriod.prices`의 키와 직접 매핑됨 (line 312: `id: key`)
- 하지만 인증 시 서버에서 반환되는 `grade` 값과 가격 키 간에 불일치 가능성
- `useMemberVerification.ts:67`에서 서버 응답의 `grade` 필드를 그대로 사용

### 2. 인증 상태 확인 타이밍 문제

**useAuth.ts**: 
- 인증 상태는 Firebase 실시간 리스너로 관리 (lines 79-144)
- `affiliations[societyId].verified` 상태는 onSnapshot을 통해 동기화

**RegistrationPage.tsx:342-354**:
- 인증 상태 확인 로직은 정확하게 구현됨
- 하지만 등급 자동 선택 로직 (lines 388-429)에서 문제 발생

### 3. 등급 매칭 로직의 취약점

**RegistrationPage.tsx:399-418**:
```typescript
const rawServer = String(memberVerificationData.grade).toLowerCase();
const normalizedServer = rawServer.replace(/\s/g, '');

const matched = grades.find(g => {
    const gCode = (g.code || '').toLowerCase().replace(/\s/g, '');
    const gName = (g.name || '').toLowerCase().replace(/\s/g, '');
    
    return gCode === normalizedServer || gName === normalizedServer || gName.includes(normalizedServer);
});
```

**문제점**:
- 서버 등급명과 가격 키 간의 매핑이 불확실
- `grades` 배열은 `activePeriod.prices`의 키를 기반으로 생성 (lines 309-316)
- 서버에서 반환된 등급이 가격 키와 정확히 일치하지 않을 경우

### 4. 데이터 흐름의 연결고리 상실

**데이터 흐름**:
1. 인증 성공 → `useMemberVerification.ts`에서 `affiliations` 저장
2. `RegistrationPage`에서 `isVerified` 상태 설정
3. 자동 등급 선택 시도
4. **문제**: 서버 등급과 가격 키 불일치로 매칭 실패

## 구체적인 문제 시나리오

### 시나리오 1: 표준화되지 않은 등급명
- 서버 응답: `"Dental Hygienist"`
- 가격 키: `"dental_hygienist"` 또는 `"hygienist"`
- 결과: 매칭 실패, 기본 등급(비회원) 선택 유지

### 시나리오 2: 공백 및 대소문자 차이
- 서버 응답: `"MEMBER"`
- 가격 키: `"member"`
- 결과: 정규화 처리로 일치 가능하나, 다른 형식의 경우 실패

## 해결 방안

### 1. 즉각적 해결책: 등급 매칭 로직 강화

**RegistrationPage.tsx** 수정:
```typescript
const getNormalizedGradeKey = (serverGrade: string): string => {
    const normalized = serverGrade.toLowerCase().replace(/\s+/g, '_');
    
    // 표준화된 매핑 테이블
    const gradeMapping = {
        'dental_hygienist': 'dental_hygienist',
        'hygienist': 'dental_hygienist',
        '치과위생사': 'dental_hygienist',
        'member': 'member',
        '정회원': 'member',
        'resident': 'resident',
        '전공의': 'resident',
        '수련의': 'resident',
        // ... 추가 매핑
    };
    
    return gradeMapping[normalized] || normalized;
};
```

### 2. 근본적 해결책: 서버-클라이언트 데이터 정합성 보장

**Backend 수정**:
- 인증 API가 표준화된 등급 코드 반환
- 클라이언트와 동일한 등급 마스터 사용

**Frontend 수정**:
- `useMemberVerification.ts`에서 등급 정규화 로직 추가
- `setMemberVerificationData` 시점에 표준화된 키 저장

### 3. 방어적 프로그래밍 추가

**RegistrationPage.tsx**:
```typescript
// 가격 조회 실패 시 fallback 로직
const findPriceByGrade = (gradeId: string, prices: Record<string, number>) => {
    // 1순위: 정확한 일치
    if (prices[gradeId] !== undefined) return prices[gradeId];
    
    // 2순위: 정규화된 키로 조회
    const normalized = gradeId.toLowerCase().replace(/\s+/g, '_');
    for (const [priceKey, price] of Object.entries(prices)) {
        const normalizedPriceKey = priceKey.toLowerCase().replace(/\s+/g, '_');
        if (normalizedPriceKey === normalized) return price;
    }
    
    // 3순위: 퍼지 매칭
    for (const [priceKey, price] of Object.entries(prices)) {
        if (priceKey.toLowerCase().includes(normalized) || 
            normalized.includes(priceKey.toLowerCase())) {
            return price;
        }
    }
    
    return undefined;
};
```

### 4. 디버깅 및 모니터링 강화

**로그 추가**:
```typescript
console.log('[DEBUG] Server grade:', memberVerificationData?.grade);
console.log('[DEBUG] Available price keys:', Object.keys(activePeriod.prices));
console.log('[DEBUG] Selected grade ID:', selectedGradeId);
console.log('[DEBUG] Matched grade:', matched);
console.log('[DEBUG] Final price:', tierPrice);
```

## 검증 방안

### 1. 단위 테스트
- 등급 매칭 로직 테스트 케이스 추가
- 다양한 등급명 형식에 대한 검증

### 2. 통합 테스트
- 실제 인증 후 등록 페이지 흐름 테스트
- 여러 학회/등급 조합 테스트

### 3. 데이터 검증
- Firebase에 저장된 인증 데이터 확인
- 가격 설정과 등급 마스터 데이터 일치성 검증

## 우선순위 제안

1. **긴급**: 등급 매칭 로직 강화 (1-2시간 소요)
2. **중기**: 서버-클라이언트 데이터 정합성 개선 (1일 소요)
3. **장기**: 아키텍처 개선 및 테스트 자동화 (3-5일 소요)

## 결론

현재 문제의 핵심은 **서버에서 반환된 등급 정보와 등록 페이지의 가격 키 간의 매핑 불일치**입니다. 즉각적인 해결을 위해서는 등급 매칭 로직을 강화하고, 장기적으로는 데이터 정합성을 보장하는 아키텍처 개선이 필요합니다.